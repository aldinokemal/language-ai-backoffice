#!/bin/sh

# Laravel Pint Pre-Commit Hook
# Automatically format PHP files before committing

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "${YELLOW}Running Laravel Pint...${NC}"

# Get list of staged PHP files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "\.php$")

if [ -z "$STAGED_FILES" ]; then
    echo "${GREEN}No PHP files to format.${NC}"
    exit 0
fi

# Determine the correct PHP executable
if command -v php >/dev/null 2>&1; then
    PHP_BIN="php"
elif [ -f "vendor/bin/php" ]; then
    PHP_BIN="vendor/bin/php"
else
    echo "${RED}Error: PHP executable not found.${NC}"
    exit 1
fi

# Determine the correct Pint path (cross-platform)
if [ -f "vendor/bin/pint" ]; then
    PINT_BIN="vendor/bin/pint"
elif [ -f "vendor/bin/pint.bat" ]; then
    PINT_BIN="vendor/bin/pint.bat"
else
    echo "${RED}Error: Laravel Pint not found. Please run 'composer install'.${NC}"
    exit 1
fi

# Run Pint on staged files
echo "${YELLOW}Formatting staged PHP files...${NC}"

# Run Pint with --dirty flag to only format modified files
$PHP_BIN $PINT_BIN --dirty --quiet

PINT_EXIT_CODE=$?

if [ $PINT_EXIT_CODE -ne 0 ]; then
    echo "${RED}Laravel Pint failed. Please fix the errors and try again.${NC}"
    exit 1
fi

# Re-stage the formatted files
echo "$STAGED_FILES" | while IFS= read -r file; do
    if [ -f "$file" ]; then
        git add "$file"
    fi
done

echo "${GREEN}âœ“ Code formatted successfully!${NC}"
exit 0
